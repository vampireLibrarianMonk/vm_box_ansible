---
- name: Ensure VM storage directory exists
  file:
    path: "{{ vm_storage_dir }}"
    state: directory
    mode: "0755"

- name: Validate Ubuntu ISO exists
  stat:
    path: "{{ vm_iso_path }}"
  register: iso_check

- name: Fail if ISO is missing
  fail:
    msg: "ISO file not found at {{ vm_iso_path }}"
  when: not iso_check.stat.exists

- name: Validate shared game-data disk exists
  stat:
    path: "{{ vm_game_disk }}"
  register: game_disk_check

- name: Fail if game disk missing
  fail:
    msg: "Game disk missing: {{ vm_game_disk }} — Run game-disk-setup.sh first."
  when: not game_disk_check.stat.exists

- name: Create OS disk if missing
  command: qemu-img create -f qcow2 "{{ vm_os_disk }}" "{{ vm_os_disk_size }}"
  args:
    creates: "{{ vm_os_disk }}"

- name: Render gaming VM XML
  template:
    src: "{{ role_path }}/templates/gaming_vm.xml.j2"
    dest: "/tmp/{{ vm_name }}.xml"

- name: Define gaming VM
  command: virsh define /tmp/{{ vm_name }}.xml
  args:
    creates: "/etc/libvirt/qemu/{{ vm_name }}.xml"

# === Copy in-guest gaming setup script to staging area ===
- name: Create staging directory for in-guest script
  file:
    path: "{{ vm_in_guest_script_staging_dir }}"
    state: directory
    mode: "0755"

- name: Copy in-guest setup script to staging directory
  copy:
    src: "{{ vm_in_guest_script_source }}"
    dest: "{{ vm_in_guest_script_staging_dir }}/{{ vm_in_guest_script_name }}"
    mode: "0755"

- name: Print script copy location
  debug:
    msg: |
      In-guest gaming setup script copied to:
        {{ vm_in_guest_script_staging_dir }}/{{ vm_in_guest_script_name }}

      To transfer into the VM:
        scp {{ vm_in_guest_script_staging_dir }}/{{ vm_in_guest_script_name }} user@VM-IP:~/
      Or via virt-manager:
        View → File Transfer → Choose this script

- name: Display next-step instructions
  debug:
    msg: |
      Gaming VM '{{ vm_name }}' successfully created.

      ============================================================
      HOST ACTION REQUIRED (RTX 3060 PASSTHROUGH SETUP)
      ============================================================

      1. Run the following script on the HOST:
           bash scripts/gaming/3060/gpu_passthrough_config.sh

         This will:
           - Detect the RTX 3060 GPU + HDMI audio PCI IDs
           - Verify IOMMU and VFIO readiness
           - Print the exact PCI IDs required for passthrough

      ============================================================
      VM INITIAL INSTALL (NO GPU ATTACHED YET)
      ============================================================

      2. Boot the VM normally (with default virtual graphics).
      3. Install Ubuntu 22.04 inside the VM.
      4. Log in once to confirm the OS boots successfully.
      5. Shut down the VM.

      ============================================================
      GPU ATTACH IN VIRT-MANAGER (VM MUST BE OFF)
      ============================================================

      6. Open virt-manager → VM Details → Add Hardware → PCI Host Device
           - RTX 3060 GPU
           - RTX 3060 HDMI Audio

      7. Remove "Video Virtio"
      8. Set Display → None
      9. Boot the VM using a monitor connected to the RTX 3060.

      ============================================================
      IN-GUEST GAMING SETUP (INSIDE THE VM)
      ============================================================

      The in-guest setup script has been staged at:
          {{ vm_in_guest_script_staging_dir }}/{{ vm_in_guest_script_name }}

      10. Transfer the script into the VM:
            scp {{ vm_in_guest_script_staging_dir }}/{{ vm_in_guest_script_name }} user@VM-IP:~/
            OR use virt-manager → View → File Transfer

      11. Inside the VM, run:
            sudo bash {{ vm_in_guest_script_name }}

      ============================================================
      POST-SETUP (IMPORTANT)
      ============================================================

      12. Reboot the VM if prompted by the script.
      13. Launch Lutris (Flatpak):
            flatpak run net.lutris.Lutris

      14. In Lutris → Preferences → Runners:
            - Set Wine runner to Proton-GE (latest) or Wine 10.x
            - Ensure DXVK is enabled

      15. Install Battle.net into:
            /mnt/games/BattleNet

      16. Install StarCraft into:
            /mnt/games/SC2

      ============================================================
      EXPECTED FINAL STATE
      ============================================================

      - GPU passthrough active
      - NVIDIA drivers loaded inside the VM
      - /mnt/games mounted and persistent
      - Steam, Battle.net, and StarCraft functional

###############################################################################
# DESTROY LOGIC (MANUAL / OPT-IN ONLY)
#
# This section NEVER runs during normal playbook execution.
# It is only executed when explicitly invoked with:
#
#   ansible-playbook <playbook>.yml --tags destroy
#
# Disks are NOT deleted. Only the VM definition + runtime are removed.
###############################################################################

- name: Power off gaming VM if running
  community.libvirt.virt:
    name: "{{ vm_name }}"
    state: destroyed
  tags: destroy

- name: Undefine gaming VM (remove XML + NVRAM)
  command: virsh undefine {{ vm_name }} --nvram
  tags: destroy
