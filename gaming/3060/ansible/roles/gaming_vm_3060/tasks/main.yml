---
- name: Ensure VM storage directory exists
  file:
    path: "{{ vm_storage_dir }}"
    state: directory
    mode: "0755"

- name: Validate Ubuntu ISO exists
  stat:
    path: "{{ vm_iso_path }}"
  register: iso_check

- name: Fail if ISO is missing
  fail:
    msg: "ISO file not found at {{ vm_iso_path }}"
  when: not iso_check.stat.exists

- name: Validate shared game-data disk exists
  stat:
    path: "{{ vm_game_disk }}"
  register: game_disk_check

- name: Fail if game disk missing
  fail:
    msg: "Game disk missing: {{ vm_game_disk }} â€” Run game-disk-setup.sh first."
  when: not game_disk_check.stat.exists

- name: Create OS disk if missing
  command: qemu-img create -f qcow2 "{{ vm_os_disk }}" "{{ vm_os_disk_size }}"
  args:
    creates: "{{ vm_os_disk }}"

- name: Render gaming VM XML
  template:
    src: "{{ role_path }}/templates/gaming_vm.xml.j2"
    dest: "/tmp/{{ vm_name }}.xml"

- name: Define gaming VM
  command: virsh define /tmp/{{ vm_name }}.xml
  args:
    creates: "/etc/libvirt/qemu/{{ vm_name }}.xml"

###############################################################################
# DESTROY LOGIC (MANUAL / OPT-IN ONLY)
#
# This section NEVER runs during normal playbook execution.
# It is only executed when explicitly invoked with:
#
#   ansible-playbook <playbook>.yml --tags destroy
#
# Disks are NOT deleted. Only the VM definition + runtime are removed.
###############################################################################

- name: Power off gaming VM if running
  community.libvirt.virt:
    name: "{{ vm_name }}"
    state: destroyed
  tags: destroy

- name: Undefine gaming VM (remove XML + NVRAM)
  command: virsh undefine {{ vm_name }} --nvram
  tags: destroy
