---
- name: Update APT package index
  apt:
    update_cache: yes

- name: Install QEMU KVM hypervisor
  apt:
    name: qemu-kvm
    state: present

- name: Install libvirt system daemon
  apt:
    name: libvirt-daemon-system
    state: present

- name: Install libvirt clients
  apt:
    name: libvirt-clients
    state: present

- name: Install virt-manager
  apt:
    name: virt-manager
    state: present

- name: Install OVMF (UEFI firmware)
  apt:
    name: ovmf
    state: present

- name: Install bridge-utils
  apt:
    name: bridge-utils
    state: present

- name: Install pciutils
  apt:
    name: pciutils
    state: present

- name: Install usbutils
  apt:
    name: usbutils
    state: present

- name: Enable & start libvirtd service
  systemd:
    name: libvirtd
    enabled: yes
    state: started

- name: Add user to libvirt and libvirt-qemu groups
  user:
    name: "{{ lookup('env', 'USER') }}"
    groups: "libvirt,libvirt-qemu"
    append: yes

###############################################################################
# GRUB | Ensure IOMMU enabled (AMD passthrough host)
###############################################################################

- name: GRUB | Read current kernel cmdline defaults
  command: grep '^GRUB_CMDLINE_LINUX_DEFAULT=' /etc/default/grub
  register: grub_cmdline
  changed_when: false

- name: GRUB | Ensure IOMMU flags present
  set_fact:
    new_grub_cmdline: >-
      {{
        grub_cmdline.stdout
        | regex_replace('"$', '')
        ~ ' amd_iommu=on iommu=pt"'
        if 'amd_iommu=on' not in grub_cmdline.stdout
        else grub_cmdline.stdout
      }}

- name: GRUB | Update GRUB kernel parameters if needed
  lineinfile:
    path: /etc/default/grub
    regexp: '^GRUB_CMDLINE_LINUX_DEFAULT='
    line: "{{ new_grub_cmdline }}"
  register: grub_updated

- name: GRUB | Update grub configuration
  command: update-grub
  when: grub_updated.changed
  register: grub_update_result

- name: GRUB | Mark reboot required
  set_fact:
    reboot_required: true
  when: grub_updated.changed

- name: Create VM storage directory
  file:
    path: "{{ vm_storage_dir }}"
    state: directory
    mode: '0755'

- name: Display completion message
  debug:
    msg: |
      Base VM Infrastructure Setup Complete.

      {% if reboot_required | default(false) %}
      ⚠️  GRUB updated — reboot REQUIRED before creating passthrough VMs.
      {% else %}
      No reboot required.
      {% endif %}
